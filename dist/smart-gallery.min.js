!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).SmartGallery=e()}(this,function(){"use strict";return class{constructor(t,e={}){if(this.container="string"==typeof t?document.querySelector(t):t,!this.container)throw new Error("SmartGallery: Container not found.");this.options=Object.assign({layout:"justified",gap:10,targetRowHeight:300,lastRowBehavior:"left",columnWidth:300,columns:"auto",className:"",itemClassName:"sg-item",virtualize:!0,buffer:500,placeholderColor:"#eee",renderItem:null,onItemClick:null},e),this.items=[],this.geometry=[],this.renderedIndices=new Set,this.resizeObserver=null,this.scrollHandler=null,this.isResizing=!1,this._init()}_init(){let t;this.container.style.position="relative",this.container.classList.add("smart-gallery"),this.options.className&&this.container.classList.add(this.options.className),this.resizeObserver=new ResizeObserver(()=>{this.isResizing||(clearTimeout(t),t=setTimeout(()=>{this.render()},100))}),this.resizeObserver.observe(this.container),this.options.virtualize&&(this.scrollHandler=this._throttle(this._handleScroll.bind(this),50),window.addEventListener("scroll",this.scrollHandler,{passive:!0}))}addItems(t){const e=t.map(t=>{let e=t.aspectRatio;return!e&&t.width&&t.height&&(e=t.width/t.height),e||(e=1),{...t,aspectRatio:e}});this.items=[...this.items,...e]}render(){if(!this.container||0===this.items.length)return;this.isResizing=!0;const t=this.container.clientWidth,{layout:e}=this.options;let i,s=0;this.renderedIndices.clear(),this.container.innerHTML="",this.geometry=[],"justified"===e?i=this._computeJustifiedLayout(this.items,t,this.options):"masonry"===e?i=this._computeMasonryLayout(this.items,t,this.options):"grid"===e&&(i=this._computeGridLayout(this.items,t,this.options)),this.geometry=i.boxes.map((t,e)=>({...t,itemIndex:e})),s=i.containerHeight,this.container.style.height=`${s}px`,this._updateVisibleItems(),this.isResizing=!1}_updateVisibleItems(){if(!this.options.virtualize)return void this._renderItems(this.geometry);const t=window.scrollY,e=window.innerHeight,i=this.options.buffer,s=this.container.getBoundingClientRect().top+t,o=Math.max(0,t-s-i),n=t-s+e+i,r=new Set;this.geometry.forEach(t=>{t.top+t.height>o&&t.top<n&&r.add(t.itemIndex)}),r.forEach(t=>{this.renderedIndices.has(t)||(this._mountItem(this.geometry[t]),this.renderedIndices.add(t))}),this.renderedIndices.forEach(t=>{r.has(t)||(this._unmountItem(t),this.renderedIndices.delete(t))})}_mountItem(t){const e=t.itemIndex,i=this.items[e],s=document.createElement("div");if(s.className=this.options.itemClassName,s.id=`sg-item-${e}`,s.style.position="absolute",s.style.left=`${t.left}px`,s.style.top=`${t.top}px`,s.style.width=`${t.width}px`,s.style.height=`${t.height}px`,this.options.renderItem)s.appendChild(this.options.renderItem(i,e));else{s.style.backgroundColor=i.placeholderColor||this.options.placeholderColor;const t=document.createElement("img");t.src=i.src,t.style.width="100%",t.style.height="100%",t.style.objectFit="cover",t.style.display="block",t.style.opacity="0",t.style.transition="opacity 0.3s",t.loading="lazy",t.onload=()=>{t.style.opacity="1"},s.appendChild(t)}s.addEventListener("click",t=>{this.options.onItemClick&&this.options.onItemClick({index:e,itemData:i,originalEvent:t})}),this.container.appendChild(s)}_unmountItem(t){const e=this.container.querySelector(`#sg-item-${t}`);e&&e.remove()}_handleScroll(){this.isResizing||requestAnimationFrame(()=>this._updateVisibleItems())}_throttle(t,e){let i;return function(){const s=arguments,o=this;i||(t.apply(o,s),i=!0,setTimeout(()=>i=!1,e))}}_computeJustifiedLayout(t,e,i){const{targetRowHeight:s,gap:o,lastRowBehavior:n}=i,r=[];let h=0;const l=t.map(t=>t.aspectRatio);let a=0;for(;a<t.length;){let i=0,c=-1,d=1/0,m=a;for(;m<t.length;){i+=l[m];const t=(e-(m-a+1-1)*o)/i;if(t<.5*s)break;const n=Math.abs(t-s);n<d&&(d=n,c=m),m++}if(-1!==c){const i=c===t.length-1;let d=0,m=c-a+1,u=0;for(let t=a;t<=c;t++)u+=l[t];const p=(m-1)*o;d=(e-p)/u;let g=0;if(i){const t=n;if("hide"===t)break;if("left"===t||"center"===t||"right"===t){d=s;const i=e-(u*d+p);"center"===t?g=Math.max(0,i/2):"right"===t&&(g=Math.max(0,i))}}let f=g;for(let t=a;t<=c;t++){const e=d*l[t];r.push({left:f,top:h,width:e,height:d}),f+=e+o}h+=d+o,a=c+1}else{const t=s*l[a];r.push({left:0,top:h,width:t,height:s}),h+=s+o,a++}}return{boxes:r,containerHeight:h}}_computeMasonryLayout(t,e,i){const{gap:s,columnWidth:o,columns:n}=i;let r=0,h=0;"auto"===n?(h=o,r=Math.floor((e+s)/(h+s)),r=Math.max(1,r),h=(e-(r-1)*s)/r):(r=n,h=(e-(r-1)*s)/r);const l=new Array(r).fill(0),a=[];return t.forEach(t=>{const e=Math.min(...l),i=l.indexOf(e),o=h/t.aspectRatio;a.push({left:i*(h+s),top:e,width:h,height:o}),l[i]+=o+s}),{boxes:a,containerHeight:Math.max(...l)}}_computeGridLayout(t,e,i){const{gap:s,columnWidth:o,columns:n}=i;let r=0,h=0;"auto"===n?(h=o,r=Math.floor((e+s)/(h+s)),r=Math.max(1,r),h=(e-(r-1)*s)/r):(r=n,h=(e-(r-1)*s)/r);const l=h,a=[];t.forEach((t,e)=>{const i=e%r,o=Math.floor(e/r);a.push({left:i*(h+s),top:o*(l+s),width:h,height:l})});const c=Math.ceil(t.length/r);return{boxes:a,containerHeight:c*(l+s)-s}}destroy(){this.resizeObserver&&this.resizeObserver.disconnect(),this.scrollHandler&&window.removeEventListener("scroll",this.scrollHandler)}}});
